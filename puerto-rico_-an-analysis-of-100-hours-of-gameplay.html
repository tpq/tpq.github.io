<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Puerto Rico: an Analysis of 100 Hours of Gameplay</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
<link rel="icon" type="image/x-icon" href="favicon.ico" />


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #0000ff; } /* Keyword */
code > span.ch { color: #008080; } /* Char */
code > span.st { color: #008080; } /* String */
code > span.co { color: #008000; } /* Comment */
code > span.ot { color: #ff4000; } /* Other */
code > span.al { color: #ff0000; } /* Alert */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #008000; font-weight: bold; } /* Warning */
code > span.cn { } /* Constant */
code > span.sc { color: #008080; } /* SpecialChar */
code > span.vs { color: #008080; } /* VerbatimString */
code > span.ss { color: #008080; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { } /* Variable */
code > span.cf { color: #0000ff; } /* ControlFlow */
code > span.op { } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #ff4000; } /* Preprocessor */
code > span.do { color: #008000; } /* Documentation */
code > span.an { color: #008000; } /* Annotation */
code > span.cv { color: #008000; } /* CommentVar */
code > span.at { } /* Attribute */
code > span.in { color: #008000; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">THOM QUINN</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="about-me.html">ABOUT ME</a>
</li>
<li>
  <a href="curriculum-vitae.html">CURRICULUM VITAE</a>
</li>
<li>
  <a href="musings.html">MUSINGS</a>
</li>
<li>
  <a href="fiction.html">FICTION</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Puerto Rico: an Analysis of 100 Hours of Gameplay</h1>

</div>


<div id="an-american-tradition" class="section level3">
<h3>An American tradition</h3>
<p>Since moving to Australia, I have made it a point to stay connected with friends back home. For two of my old gaming buddies, we catch up regularly for a chat over a round of Puerto Rico, a resource management board game by Andreas Seyfarth. We play online through <a href="https://en.boardgamearena.com/">Board Game Arena</a>, a free platform that provides a clean interface for dozens of board games.</p>
<p>As a coding project, I wrote a module in Python to scrape and parse logs from each of our games. Using this module, I retrieved data for (most) games played between the players ‘buzzsnuzz’ (me), ‘Airjoe’ (Joseph), and ‘pmac135’ (Patrick), excepting those that used expansion cards (or otherwise failed to download). This blog post is dedicated to these two who, being data fiends like myself, I hope will enjoy reading these results as much as I enjoyed generating them.</p>
</div>
<div id="a-game-of-quarry-rock-and-roles" class="section level3">
<h3>A game of quarry rock and roles</h3>
<p>The retrieved data exist in two parts. The first part is simple, listing which roles were called (and by whom). The second part is comprehensive, listing what pieces each player acquired on each turn. Here, we import the first part of the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">files &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="st">&quot;data/&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)
files.turns &lt;-<span class="st"> </span>files[<span class="kw">grepl</span>(<span class="st">&quot;bga[0-9]+</span><span class="ch">\\</span><span class="st">.csv&quot;</span>, files)]</code></pre></div>
<p>How many games have we played?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">length</span>(files.turns)</code></pre></div>
<pre><code>## [1] 53</code></pre>
<p>Each round, every player has a turn. How many turns are in a full game?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(yuck)
turns &lt;-<span class="st"> </span><span class="kw">lapply</span>(files.turns, read.csv)
players <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="cf">for</span>(turn <span class="cf">in</span> turns) <span class="kw">t</span>(turn)[<span class="dv">2</span>,,drop=<span class="ot">FALSE</span>]
roles <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="cf">for</span>(turn <span class="cf">in</span> turns) <span class="kw">t</span>(turn)[<span class="dv">1</span>,,drop=<span class="ot">FALSE</span>]
<span class="kw">table</span>(<span class="st">&quot;Turns&quot;</span> =<span class="st"> </span><span class="kw">sapply</span>(roles, length))</code></pre></div>
<pre><code>## Turns
## 39 45 48 51 54 57 
##  1 12 14 13 11  2</code></pre>
<p>Each turn, a player selects a role. Which roles are most popular?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(<span class="st">&quot;Role&quot;</span> =<span class="st"> </span><span class="kw">unlist</span>(roles))</code></pre></div>
<pre><code>## Role
##   builder   captain craftsman     mayor   settler    trader 
##       533       445       413       456       405       370</code></pre>
<p>How does the popularity of each role change over time?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rolesm <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="cf">for</span>(turn <span class="cf">in</span> roles) <span class="kw">as.data.frame</span>(turn)
rolesm &lt;-<span class="st"> </span>plyr<span class="op">::</span><span class="kw">rbind.fill</span>(rolesm)
<span class="kw">colnames</span>(rolesm) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Turn&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(rolesm))
<span class="kw">rownames</span>(rolesm) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Game&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(rolesm))
df.r &lt;-<span class="st"> </span>reshape2<span class="op">::</span><span class="kw">melt</span>(<span class="kw">t</span>(rolesm))
<span class="kw">colnames</span>(df.r) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Turn&quot;</span>, <span class="st">&quot;Game&quot;</span>, <span class="st">&quot;Role&quot;</span>)
df.r &lt;-<span class="st"> </span>ggplot2<span class="op">::</span><span class="kw">remove_missing</span>(df.r)
<span class="kw">library</span>(ggplot2)
<span class="kw">ggplot</span>(df.r, <span class="kw">aes</span>(<span class="dt">x =</span> Turn, <span class="dt">fill =</span> Role)) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>Role) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">stat =</span> <span class="st">&quot;count&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Set2&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Turn&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Frequency&quot;</span>)</code></pre></div>
<p><img src="puerto-rico_-an-analysis-of-100-hours-of-gameplay_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>Which roles tend to follow other roles? Note, the number nearest the node indicates the outgoing probability.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(markovchain)
mcFit &lt;-<span class="st"> </span><span class="kw">markovchainFit</span>(<span class="kw">sapply</span>(roles, as.vector))
<span class="kw">plot</span>(mcFit<span class="op">$</span>estimate, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>)</code></pre></div>
<p><img src="puerto-rico_-an-analysis-of-100-hours-of-gameplay_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>Which roles tend to follow other roles? Note, rows indicate the first state.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mc &lt;-<span class="st"> </span>mcFit<span class="op">$</span>estimate<span class="op">@</span>transitionMatrix
mc</code></pre></div>
<pre><code>##              builder    captain   craftsman     mayor    settler    trader
## builder   0.01529637 0.19120459 0.193116635 0.3212237 0.17017208 0.1089866
## captain   0.28929385 0.02050114 0.170842825 0.2050114 0.16628702 0.1480638
## craftsman 0.17574257 0.28712871 0.004950495 0.1113861 0.09405941 0.3267327
## mayor     0.20814480 0.12669683 0.269230769 0.0361991 0.22171946 0.1380090
## settler   0.34090909 0.14141414 0.169191919 0.2045455 0.01515152 0.1287879
## trader    0.24383562 0.29589041 0.134246575 0.1534247 0.16164384 0.0109589</code></pre>
<p>What is the most common transition for each role?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">L &lt;-<span class="st"> </span><span class="kw">apply</span>(mc, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="kw">rownames</span>(mc)[<span class="kw">which.max</span>(x)])
L <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="cf">for</span>(l <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(L)) <span class="kw">paste</span>(<span class="kw">names</span>(L)[l], <span class="st">&quot;-&gt;&quot;</span>, L[l])
L</code></pre></div>
<pre><code>## [1] &quot;builder -&gt; mayor&quot;    &quot;captain -&gt; builder&quot;  &quot;craftsman -&gt; trader&quot;
## [4] &quot;mayor -&gt; craftsman&quot;  &quot;settler -&gt; builder&quot;  &quot;trader -&gt; captain&quot;</code></pre>
</div>
<div id="the-winning-positioned-here" class="section level3">
<h3>The winning positioned here</h3>
<p>Now, we import the second part of the data. We have one file per player per game.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">files.a &lt;-<span class="st"> </span>files[<span class="kw">grepl</span>(<span class="st">&quot;Airjoe.csv&quot;</span>, files)]
data.a &lt;-<span class="st"> </span><span class="kw">lapply</span>(files.a, read.csv)
files.t &lt;-<span class="st"> </span>files[<span class="kw">grepl</span>(<span class="st">&quot;buzzsnuzz.csv&quot;</span>, files)]
data.t &lt;-<span class="st"> </span><span class="kw">lapply</span>(files.t, read.csv)
files.p &lt;-<span class="st"> </span>files[<span class="kw">grepl</span>(<span class="st">&quot;pmac135.csv&quot;</span>, files)]
data.p &lt;-<span class="st"> </span><span class="kw">lapply</span>(files.p, read.csv)</code></pre></div>
<p>First, let us calculate the winners for each game (and their score).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">which.median &lt;-<span class="st"> </span><span class="cf">function</span>(x) (<span class="kw">which</span>(x <span class="op">==</span><span class="st"> </span><span class="kw">median</span>(x)))[<span class="dv">1</span>]
vp.a &lt;-<span class="st"> </span><span class="kw">sapply</span>(data.a, <span class="cf">function</span>(d) <span class="kw">sum</span>(<span class="kw">colSums</span>(d[, <span class="kw">grepl</span>(<span class="st">&quot;vp_&quot;</span>, <span class="kw">colnames</span>(d))])))
vp.t &lt;-<span class="st"> </span><span class="kw">sapply</span>(data.t, <span class="cf">function</span>(d) <span class="kw">sum</span>(<span class="kw">colSums</span>(d[, <span class="kw">grepl</span>(<span class="st">&quot;vp_&quot;</span>, <span class="kw">colnames</span>(d))])))
vp.p &lt;-<span class="st"> </span><span class="kw">sapply</span>(data.p, <span class="cf">function</span>(d) <span class="kw">sum</span>(<span class="kw">colSums</span>(d[, <span class="kw">grepl</span>(<span class="st">&quot;vp_&quot;</span>, <span class="kw">colnames</span>(d))])))
vp.atp &lt;-<span class="st"> </span><span class="kw">data.frame</span>(vp.a, vp.t, vp.p)
Winner &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Airjoe&quot;</span>, <span class="st">&quot;buzzsnuzz&quot;</span>, <span class="st">&quot;pmac135&quot;</span>)[<span class="kw">apply</span>(vp.atp, <span class="dv">1</span>, which.max)]
LoserM &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Airjoe&quot;</span>, <span class="st">&quot;buzzsnuzz&quot;</span>, <span class="st">&quot;pmac135&quot;</span>)[<span class="kw">apply</span>(vp.atp, <span class="dv">1</span>, which.median)]
Loser &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Airjoe&quot;</span>, <span class="st">&quot;buzzsnuzz&quot;</span>, <span class="st">&quot;pmac135&quot;</span>)[<span class="kw">apply</span>(vp.atp, <span class="dv">1</span>, which.min)]</code></pre></div>
<p>What player wins most often?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(<span class="st">&quot;Player&quot;</span> =<span class="st"> </span>Winner)</code></pre></div>
<pre><code>## Player
##    Airjoe buzzsnuzz   pmac135 
##        21        17        15</code></pre>
<p>What is the spread?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gameorder &lt;-<span class="st"> </span><span class="kw">order</span>(<span class="kw">as.numeric</span>(<span class="kw">gsub</span>(<span class="st">&quot;(bga)|(</span><span class="ch">\\</span><span class="st">.csv)&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">basename</span>(files.turns))))
s.atp &lt;-<span class="st"> </span><span class="kw">apply</span>(vp.atp, <span class="dv">1</span>, <span class="cf">function</span>(x) x <span class="op">-</span><span class="st"> </span><span class="kw">median</span>(x))
<span class="kw">rownames</span>(s.atp) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Airjoe&quot;</span>, <span class="st">&quot;buzzsnuzz&quot;</span>, <span class="st">&quot;pmac135&quot;</span>)
df.s &lt;-<span class="st"> </span>reshape2<span class="op">::</span><span class="kw">melt</span>(<span class="kw">t</span>(s.atp))
<span class="kw">ggplot</span>(df.s, <span class="kw">aes</span>(<span class="dt">x =</span> Var1, <span class="dt">y =</span> value, <span class="dt">fill =</span> Var2)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Set2&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Game&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Spread from Median&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">fill =</span> <span class="st">&quot;Player&quot;</span>)</code></pre></div>
<p><img src="puerto-rico_-an-analysis-of-100-hours-of-gameplay_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p>A game can change a lot depending on player order. Do some positions have an advantage?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">turn <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="cf">for</span>(turn <span class="cf">in</span> turns) <span class="kw">t</span>(turn)[<span class="dv">2</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>,drop=<span class="ot">FALSE</span>]
WinnerPos <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(turn)) <span class="kw">which</span>(turn[[i]] <span class="op">%in%</span><span class="st"> </span>Winner[i])
<span class="kw">table</span>(<span class="st">&quot;Position&quot;</span> =<span class="st"> </span>WinnerPos)</code></pre></div>
<pre><code>## Position
##  1  2  3 
## 22 11 20</code></pre>
<p>How does position affect each player?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(<span class="st">&quot;Position&quot;</span> =<span class="st"> </span>WinnerPos, <span class="st">&quot;Player&quot;</span> =<span class="st"> </span>Winner)</code></pre></div>
<pre><code>##         Player
## Position Airjoe buzzsnuzz pmac135
##        1      6         9       7
##        2      7         2       2
##        3      8         6       6</code></pre>
</div>
<div id="of-yearnings-and-earnings" class="section level3">
<h3>Of yearnings and earnings</h3>
<p>For statistical modeling and visualization, we want the data in long format. Here, we convert a list of matrices into one very large matrix. You can download this data set <a href="data/pr-frequency.csv">here</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gameid &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="kw">strsplit</span>(<span class="kw">basename</span>(files.a), <span class="st">&quot;-&quot;</span>), <span class="cf">function</span>(f) f[<span class="dv">1</span>])
data &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(data.a), <span class="cf">function</span>(i){
  <span class="kw">data.frame</span>(
    <span class="st">&quot;game&quot;</span> =<span class="st"> </span>gameid[i],
    <span class="kw">do.call</span>(<span class="st">&quot;rbind&quot;</span>,
            <span class="kw">list</span>(
              <span class="kw">data.frame</span>(<span class="st">&quot;name&quot;</span> =<span class="st"> &quot;Airjoe&quot;</span>,
                         <span class="st">&quot;pos&quot;</span> =<span class="st"> </span><span class="kw">grep</span>(<span class="st">&quot;Airjoe&quot;</span>, players[[i]])[<span class="dv">1</span>],
                         data.a[[i]]),
              <span class="kw">data.frame</span>(<span class="st">&quot;name&quot;</span> =<span class="st"> &quot;buzzsnuzz&quot;</span>,
                         <span class="st">&quot;pos&quot;</span> =<span class="st"> </span><span class="kw">grep</span>(<span class="st">&quot;buzzsnuzz&quot;</span>, players[[i]])[<span class="dv">1</span>],
                         data.t[[i]]),
              <span class="kw">data.frame</span>(<span class="st">&quot;name&quot;</span> =<span class="st"> &quot;pmac135&quot;</span>,
                         <span class="st">&quot;pos&quot;</span> =<span class="st"> </span><span class="kw">grep</span>(<span class="st">&quot;pmac135&quot;</span>, players[[i]])[<span class="dv">1</span>],
                         data.p[[i]])
            )))})
df &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&quot;rbind&quot;</span>, data)
df<span class="op">$</span>vp &lt;-<span class="st"> </span>df<span class="op">$</span>vp_ship <span class="op">+</span><span class="st"> </span>df<span class="op">$</span>vp_harbor <span class="op">+</span><span class="st"> </span>df<span class="op">$</span>vp_bld <span class="op">+</span><span class="st"> </span>df<span class="op">$</span>vp_bonus</code></pre></div>
<p>The data above describe what pieces were acquired on each turn. However, we more often want to know whether a piece is held on a given turn. This means that we should arrange the data by the cumulative sum (per player per game). We do this with <code>aggregate</code> (followed by <code>lapply</code> to unnest the results). You can download this data set <a href="data/pr-cumsum.csv">here</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df.cumsum &lt;-<span class="st"> </span><span class="kw">aggregate</span>(. <span class="op">~</span><span class="st"> </span>game <span class="op">+</span><span class="st"> </span>name <span class="op">+</span><span class="st"> </span>pos, df, <span class="dt">FUN =</span> cumsum)
df.cs &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(df.cumsum), <span class="cf">function</span>(row){
  df.i &lt;-<span class="st"> </span><span class="kw">do.call</span>(data.frame, df.cumsum[row,])
  <span class="kw">names</span>(df.i) &lt;-<span class="st"> </span><span class="kw">names</span>(df.cumsum)
  <span class="kw">data.frame</span>(<span class="st">&quot;X&quot;</span> =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(df.i), df.i)
})
df.cs &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&quot;rbind&quot;</span>, df.cs)</code></pre></div>
<p>Now, we can easily visualize the average number of victory points (VP) earned over the course of a game for each player. We know that starting position can influence game outcomes, so we will separate the trends based on this factor.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df.m &lt;-<span class="st"> </span><span class="kw">aggregate</span>(vp <span class="op">~</span><span class="st"> </span>name <span class="op">+</span><span class="st"> </span>X <span class="op">+</span><span class="st"> </span>pos, df.cs, mean)
<span class="kw">ggplot</span>(df.m, <span class="kw">aes</span>(<span class="dt">x =</span> X, <span class="dt">y =</span> vp, <span class="dt">col =</span> <span class="kw">factor</span>(pos))) <span class="op">+</span><span class="st"> </span><span class="kw">facet_grid</span>(<span class="op">~</span>name) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Set2&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Turn&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;VP Earned (Average)&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">col =</span> <span class="st">&quot;Position&quot;</span>)</code></pre></div>
<p><img src="puerto-rico_-an-analysis-of-100-hours-of-gameplay_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>We can also visualize how ownership of a building changes the rate of VP earnings (as further broken down by player and position). For example, we see below how ownership of the “Harbor” building can yield more VP.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df.m &lt;-<span class="st"> </span><span class="kw">aggregate</span>(vp <span class="op">~</span><span class="st"> </span>name <span class="op">+</span><span class="st"> </span>X <span class="op">+</span><span class="st"> </span>pos <span class="op">+</span><span class="st"> </span>harbor, df.cs, mean)
<span class="kw">ggplot</span>(df.m, <span class="kw">aes</span>(<span class="dt">x =</span> X, <span class="dt">y =</span> vp, <span class="dt">col =</span> <span class="kw">factor</span>(harbor))) <span class="op">+</span><span class="st"> </span><span class="kw">facet_grid</span>(pos<span class="op">~</span>name) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Set2&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Turn&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;VP Earned (Average)&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">col =</span> <span class="st">&quot;Harbor Ownership&quot;</span>)</code></pre></div>
<p><img src="puerto-rico_-an-analysis-of-100-hours-of-gameplay_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
</div>
<div id="weighing-in-on-the-game" class="section level3">
<h3>Weighing in on the game</h3>
<p>As an analyst and player, I want to know which buildings provide the most value in terms of VP earnings. One way to assess this is by fitting a linear model to VP earnings, and then comparing the weight of the coefficients for each building. By modeling turn order as a covariate (labeled as “X”), the coefficients of the linear model should estimate how well building ownership correlates with VP earnings while adjusting for the natural course of the game.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw">lm</span>(vp <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="dv">0</span>, df.cs[, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">26</span><span class="op">:</span><span class="dv">49</span>)])
coefTotal &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">t</span>(<span class="kw">coefficients</span>(fit)))
<span class="kw">colnames</span>(coefTotal) &lt;-<span class="st"> &quot;Weight&quot;</span>
<span class="kw">round</span>(coefTotal, <span class="dv">2</span>)</code></pre></div>
<pre><code>##                    Weight
## X                    0.58
## small.indigo.plant  -1.48
## small.sugar.mill    -1.14
## small.market        -1.18
## hacienda            -1.55
## construction.hut    -0.17
## small.warehouse      1.09
## indigo.plant        -0.27
## sugar.mill           0.79
## hospice             -0.13
## office              -2.20
## large.market        -0.30
## large.warehouse      3.80
## tobacco.storage      0.83
## coffee.roaster      -0.20
## factory              1.23
## university           1.35
## harbor               3.96
## wharf                4.68
## guild.hall           4.83
## customs.house        7.12
## residence            4.59
## city.hall            4.00
## fortress             4.00</code></pre>
<p>How does the value of buildings (in terms of VP earnings) change for each player?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">coefPerP &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">unique</span>(df.cs<span class="op">$</span>name), <span class="cf">function</span>(name){
  fit &lt;-<span class="st"> </span><span class="kw">lm</span>(vp <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="dv">0</span>, df.cs[df.cs<span class="op">$</span>name <span class="op">==</span><span class="st"> </span>name, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">26</span><span class="op">:</span><span class="dv">49</span>)])
  <span class="kw">data.frame</span>(name, <span class="kw">t</span>(<span class="kw">coefficients</span>(fit)))
})
coefPerP &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">do.call</span>(<span class="st">&quot;rbind&quot;</span>, coefPerP)[,<span class="op">-</span><span class="dv">1</span>])
<span class="kw">colnames</span>(coefPerP) &lt;-<span class="st"> </span><span class="kw">unique</span>(df.cs<span class="op">$</span>name)
<span class="kw">round</span>(coefPerP, <span class="dv">2</span>)</code></pre></div>
<pre><code>##                    Airjoe buzzsnuzz pmac135
## X                    0.56      0.54    0.64
## small.indigo.plant  -0.62     -0.81   -2.61
## small.sugar.mill    -0.73     -1.19   -1.51
## small.market        -1.90     -0.24   -0.85
## hacienda            -1.68     -1.44   -2.67
## construction.hut    -0.49      0.17   -1.65
## small.warehouse      3.02      1.95   -0.16
## indigo.plant         0.93     -0.28   -2.57
## sugar.mill           0.56      3.58   -0.37
## hospice             -0.18      0.99   -1.51
## office              -4.50     -0.72   -1.99
## large.market        -0.73     -2.24    1.21
## large.warehouse      2.18      1.37    6.28
## tobacco.storage      0.91      1.74    0.31
## coffee.roaster       1.01     -0.44   -0.63
## factory              0.11      1.47    2.54
## university           6.19      2.29   -0.94
## harbor               3.39      4.30    4.06
## wharf                5.07      6.92    4.23
## guild.hall           6.90      3.50    2.93
## customs.house        7.75      8.47    6.79
## residence            6.54      3.33    1.52
## city.hall            3.10      5.55    4.40
## fortress             5.27      6.34    3.36</code></pre>
<p>How does the value of buildings (in terms of VP earnings) change for each player in first position?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df.cs<span class="op">$</span>np &lt;-<span class="st"> </span><span class="kw">paste0</span>(df.cs<span class="op">$</span>name, <span class="st">&quot;-&quot;</span>, df.cs<span class="op">$</span>pos)
coefPerNP &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">unique</span>(df.cs<span class="op">$</span>np), <span class="cf">function</span>(np){
  fit &lt;-<span class="st"> </span><span class="kw">lm</span>(vp <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="dv">0</span>, df.cs[df.cs<span class="op">$</span>np <span class="op">==</span><span class="st"> </span>np, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">26</span><span class="op">:</span><span class="dv">49</span>)])
  <span class="kw">data.frame</span>(np, <span class="kw">t</span>(<span class="kw">coefficients</span>(fit)))
})
coefPerNP &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">do.call</span>(<span class="st">&quot;rbind&quot;</span>, coefPerNP)[,<span class="op">-</span><span class="dv">1</span>])
<span class="kw">colnames</span>(coefPerNP) &lt;-<span class="st"> </span><span class="kw">unique</span>(df.cs<span class="op">$</span>np)
<span class="kw">round</span>(coefPerNP, <span class="dv">2</span>)[,<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]</code></pre></div>
<pre><code>##                    Airjoe-1 buzzsnuzz-1 pmac135-1
## X                      0.52        0.48      0.70
## small.indigo.plant    -1.20       -1.49     -2.80
## small.sugar.mill       2.14        0.27     -0.42
## small.market          -0.94        1.72     -1.29
## hacienda              -2.46       -1.59     -4.37
## construction.hut       3.38        2.27     -0.34
## small.warehouse        8.13        0.85      0.19
## indigo.plant           2.67       -0.71     -2.79
## sugar.mill             1.63        4.79     -0.91
## hospice                0.29       -0.48     -2.11
## office                -1.90       -2.21     -2.69
## large.market           0.01       -1.75     13.03
## large.warehouse       -4.06        3.92      7.08
## tobacco.storage        0.60       -0.12     -0.59
## coffee.roaster         2.13        1.60     -1.55
## factory               -0.74        1.01      4.22
## university               NA        3.26     -0.73
## harbor                 3.28        4.92      2.32
## wharf                  6.21        4.48      3.50
## guild.hall            10.36        3.35     -0.23
## customs.house          4.11       12.88      6.18
## residence              4.48        3.14      2.57
## city.hall              2.68        5.40      3.17
## fortress               4.91        9.55      3.05</code></pre>
<p>How does the value of buildings (in terms of VP earnings) change for each player in second position?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">round</span>(coefPerNP, <span class="dv">2</span>)[,<span class="dv">4</span><span class="op">:</span><span class="dv">6</span>]</code></pre></div>
<pre><code>##                    Airjoe-2 buzzsnuzz-2 pmac135-2
## X                      0.52        0.54      0.39
## small.indigo.plant    -2.36       -0.92     -1.43
## small.sugar.mill      -0.16       -1.64     -0.39
## small.market          -0.14       -1.41      1.41
## hacienda              -0.79       -1.64      0.08
## construction.hut       0.21       -0.33     -1.13
## small.warehouse        2.48        2.48      0.47
## indigo.plant          -0.75       -0.24     -2.12
## sugar.mill             0.07        4.91     -0.92
## hospice                1.14       -0.32     -0.95
## office                -5.15        6.31      3.98
## large.market          -3.04          NA      1.13
## large.warehouse        6.95        2.86      2.76
## tobacco.storage        0.31        3.43      2.47
## coffee.roaster         0.32       -0.92      1.14
## factory                2.11        0.85      4.31
## university             3.63        1.42      2.31
## harbor                 2.89        0.53      8.33
## wharf                  5.26        6.08      4.12
## guild.hall             5.15        3.11      8.26
## customs.house          7.40        8.89      6.66
## residence              7.57          NA      4.07
## city.hall              4.82        6.43      2.16
## fortress               8.28        9.57      6.92</code></pre>
<p>How does the value of buildings (in terms of VP earnings) change for each player in third position?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">round</span>(coefPerNP, <span class="dv">2</span>)[,<span class="dv">7</span><span class="op">:</span><span class="dv">9</span>]</code></pre></div>
<pre><code>##                    Airjoe-3 buzzsnuzz-3 pmac135-3
## X                      0.50        0.59      0.69
## small.indigo.plant     2.81        3.72     -0.95
## small.sugar.mill      -0.92       -3.35     -1.31
## small.market          -2.54        0.40     -2.24
## hacienda              -0.07        2.24     -0.90
## construction.hut       0.60       -2.92     -1.95
## small.warehouse        2.89        1.02     -0.16
## indigo.plant           6.68        0.76      9.36
## sugar.mill             1.25       -1.40     -0.59
## hospice                0.18        2.21     -0.54
## office                -5.08       -0.55     -2.56
## large.market             NA       -2.89      2.20
## large.warehouse          NA        0.13      8.12
## tobacco.storage        1.83        1.26     -0.50
## coffee.roaster         2.88        0.06     -0.21
## factory                0.04       -0.60     -0.23
## university            16.87       -2.74      1.54
## harbor                 2.23        3.96      2.33
## wharf                  4.07        7.22      3.23
## guild.hall             7.50        8.43      3.66
## customs.house         10.20        8.66      6.65
## residence              8.79        5.83        NA
## city.hall              5.18        6.97      4.83
## fortress               5.56        0.60      1.49</code></pre>
<p>The linear models above implicitly assume that the ownership of each building contributes independently to VP earned. However, we might expect that the joint ownership of some building pairs could contribute more toward VP earnings than the ownernship of either building individually. We can estimate the synergistic value of joint ownership by fitting another linear model that considers the interaction effect between building ownership. For this, we fit 529 linear models (i.e., for all pairs of 23 buildings), wherein we replace each pair of two-level factors (i.e., ownership of building A or B as binary states) with a four-level factor (i.e., ownership of neither, the first, the second, or both). As above, we include turn order as a covariate. However, because we fit a separate model for each building pair, we should fix the turn order coefficient (chosen as 0.58 from above) to keep results comparable across the 529 models.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df.b &lt;-<span class="st"> </span>df.cs[, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">26</span><span class="op">:</span><span class="dv">49</span>)]
buildings &lt;-<span class="st"> </span><span class="kw">names</span>(df.b)[<span class="dv">2</span><span class="op">:</span>(<span class="kw">length</span>(df.b)<span class="op">-</span><span class="dv">1</span>)]
outer &lt;-<span class="st"> </span><span class="kw">lapply</span>(buildings, <span class="cf">function</span>(b1){
  inner &lt;-<span class="st"> </span><span class="kw">lapply</span>(buildings, <span class="cf">function</span>(b2){
    form &lt;-<span class="st"> </span><span class="kw">as.formula</span>(<span class="kw">paste0</span>(<span class="st">&quot;vp ~ &quot;</span>, b1, <span class="st">&quot; * &quot;</span>, b2, <span class="st">&quot; + offset(I(0.58 * X)) + 0&quot;</span>))
    fit &lt;-<span class="st"> </span><span class="kw">lm</span>(form, df.b)
    coefTotal &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">coefficients</span>(fit))
    <span class="cf">if</span>(b1 <span class="op">==</span><span class="st"> </span>b2){
      <span class="kw">colnames</span>(coefTotal) &lt;-<span class="st"> &quot;X11&quot;</span>
    }<span class="cf">else</span>{
      <span class="kw">colnames</span>(coefTotal) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;X10&quot;</span>, <span class="st">&quot;X01&quot;</span>, <span class="st">&quot;X11&quot;</span>)
    }
    <span class="kw">data.frame</span>(<span class="st">&quot;A&quot;</span> =<span class="st"> </span>b1, <span class="st">&quot;B&quot;</span> =<span class="st"> </span>b2, coefTotal)
  })
  <span class="kw">do.call</span>(plyr<span class="op">::</span>rbind.fill, inner)
})
interactions &lt;-<span class="st"> </span><span class="kw">do.call</span>(plyr<span class="op">::</span>rbind.fill, outer)</code></pre></div>
<p>Here, the coefficient “X11” represents the benefit of joint ownership (i.e., the value added beyond owning each building individually “X10” and “X01”). As such, we can conceive of “X11” as a kind of synergy score which describes the amount of VP earned by owning both buildings together that is not simply explained by owning them separately.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df.i &lt;-<span class="st"> </span>reshape2<span class="op">::</span><span class="kw">melt</span>(interactions[,<span class="kw">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;X11&quot;</span>)])</code></pre></div>
<pre><code>## Using A, B as id variables</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df.i<span class="op">$</span>valuecut &lt;-<span class="st"> </span><span class="kw">cut</span>(df.i<span class="op">$</span>value, <span class="kw">seq</span>(<span class="op">-</span><span class="dv">25</span>, <span class="dv">25</span>, <span class="dv">5</span>))
<span class="kw">ggplot</span>(df.i, <span class="kw">aes</span>(<span class="dt">x =</span> B, <span class="dt">y =</span> A, <span class="dt">fill =</span> valuecut)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_tile</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Set2&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">1</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Building&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Building&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">fill =</span> <span class="st">&quot;VP Earned&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;The Synergy of Joint Building Ownership&quot;</span>)</code></pre></div>
<p><img src="puerto-rico_-an-analysis-of-100-hours-of-gameplay_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
</div>
<div id="final-remarks" class="section level3">
<h3>Final remarks</h3>
<p>I have gained a few insights from this analysis, but will leave it to the reader to draw their own conclusions. However, I wish to say that I am a big fan of interpreting linear model weights directly, and I think this use case provides a good example of how coefficients can simplify the interpretation of multi-dimensional data. Still, these weights carry with them the age old problem of <em>post hoc ergo propter hoc</em>. This analysis only tells us whether building ownership correlates with VP earnings (and not whether it is causal). It is always possible that players who are not earning VP acquire certain buildings because they are already in a rut!</p>
<p><br></p>
</div>

<div style="position: relative">
  <p style="position: relative; bottom: 0; width:100%; text-align: center; font-size: small">
    &copy; 2018 | <a href="mailto:thom@tpq.me">thom@tpq.me</a> |
    <a href="http://twitter.com/tpq__">Twitter</a> |
    <a href="http://github.com/tpq"> GitHub</a>
  </p>
</div>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
